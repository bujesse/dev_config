#!/usr/bin/env bash
set -euo pipefail

STATE_DIR="/tmp/codex"
LOG_FILE="$STATE_DIR/codex.current.log"

die(){ printf '%s\n' "$*" >&2; exit 1; }
have(){ command -v "$1" >/dev/null 2>&1; }

copy_to_clipboard() {
  if have pbcopy; then pbcopy; return; fi
  if have wl-copy; then wl-copy; return; fi
  if have xclip; then xclip -selection clipboard; return; fi
  if have xsel; then xsel --clipboard --input; return; fi
  if have clip.exe; then clip.exe; return; fi
  if have powershell.exe; then powershell.exe -NoProfile -Command "Set-Clipboard -Value ([Console]::In.ReadToEnd())" >/dev/null; return; fi
  die "No clipboard tool found (pbcopy/wl-copy/xclip/xsel/clip.exe/powershell.exe)."
}

strip_ansi() {
  sed -E \
    -e $'s/\r//g' \
    -e $'s/\x1B\\[[0-9;?]*[ -/]*[@-~]//g' \
    -e $'s/\x1B\\][0-9];[^\\x07]*\\x07//g' \
    -e $'s/\x1B\\][0-9];[^\\x1B]*\\x1B\\\\//g'
}

extract_last_block() {
  # last block that starts with "•" and ends before next "›"
  awk '
    function flush(){ if(inblk){ blocks[++n]=blk; blk=""; inblk=0 } }
    /^\s*›/ { flush(); next }
    /^\s*•/ { flush(); inblk=1 }
    { if(inblk) blk = (blk ? blk ORS $0 : $0) }
    END { flush(); if(n>0) print blocks[n] }
  '
}

[[ -f "$LOG_FILE" ]] || die "No log yet. Start Codex with: codex-wrap"

# Extracts the last Codex response from a live codex TUI log.
# - Strips ANSI and Codex UI chrome (bullets, prompts, status text).
# - Heuristically unwraps terminal hard-wraps while preserving real paragraphs and lists.
# - Trims fixed left indentation added by the TUI.
strip_ansi <"$LOG_FILE" \
| extract_last_block \
| sed -E '
    s/^[[:space:]]*•[[:space:]]*//;                        # drop leading bullet
    s/[[:alpha:]]*›.*$//;                                  # drop prompt marker + everything after
    s/[0-9]{1,3}%[[:space:]]+context[[:space:]]+left.*$//; # drop status tail
    s/^[[:space:]]{4}//;                                   # trim 4-space indent
    s/[[:space:]]+$//;                                     # trim right
  ' \
| awk '
    function flush(){ if(buf!=""){ print buf; buf="" } }

    /^[[:space:]]*$/ { flush(); print ""; next }

    # Keep structural lines as boundaries (do not join across these).
    /^[[:space:]]*[-*][[:space:]]+/ || /^[[:space:]]*[A-Za-z0-9].*:[[:space:]]*$/ {
      flush(); buf=$0; next
    }

    # Join continuation lines to undo terminal hard-wraps.
    {
      if(buf=="") buf=$0
      else buf = buf " " $0
    }

    END { flush() }
  ' \
| sed -E 's/[[:space:]]{2,}/ /g; s/[[:space:]]+$//;' \
| copy_to_clipboard

